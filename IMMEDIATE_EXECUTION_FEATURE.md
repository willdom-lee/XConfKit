# 立即执行功能说明

## 功能概述

新增"立即执行"功能，允许用户立即执行一次备份策略来验证效果，不影响原有的调度规则。

## 功能特点

### 1. 立即执行 vs 调度执行

| 功能 | 立即执行 | 调度执行 |
|------|----------|----------|
| 触发方式 | 手动点击按钮 | 自动按时间调度 |
| 影响调度 | 不影响原有调度 | 更新下次执行时间 |
| 执行频率 | 一次性 | 按策略规则 |
| 用途 | 测试验证 | 自动化备份 |

### 2. 按钮设计

- **按钮名称**: "立即执行"
- **图标**: ⚡ (ThunderboltOutlined)
- **样式**: 主要按钮 (type="primary")
- **状态**: 仅当策略启用时可用

## 技术实现

### 1. 前端实现

**按钮组件**:
```javascript
<Button
  size="small"
  icon={<ThunderboltOutlined />}
  onClick={() => executeStrategyNow(record.id)}
  disabled={!record.is_active}
  type="primary"
>
  立即执行
</Button>
```

**执行函数**:
```javascript
const executeStrategyNow = async (strategyId) => {
  try {
    const result = await strategyAPI.executeStrategyNow(strategyId);
    if (result.success) {
      message.success('策略立即执行成功');
    } else {
      message.error(`策略执行失败: ${result.message}`);
    }
    fetchStrategies();
  } catch (error) {
    message.error('策略执行失败');
  }
};
```

### 2. 后端实现

**API端点**:
```python
@router.post("/{strategy_id}/execute-now", response_model=ResponseModel)
def execute_strategy_now(strategy_id: int, db: Session = Depends(get_db)):
    """立即执行备份策略（不影响调度）"""
    # 执行备份但不更新策略状态
```

**关键区别**:
- 立即执行：只执行备份，不更新策略的 `last_execution` 和 `next_execution`
- 调度执行：执行备份后更新策略状态

### 3. API接口

**立即执行API**:
```http
POST /api/strategies/{strategy_id}/execute-now
```

**响应格式**:
```json
{
  "success": true,
  "message": "策略立即执行成功，备份已完成"
}
```

## 使用场景

### 1. 策略验证
- 创建新策略后立即测试
- 验证设备连接和备份命令
- 检查备份文件生成

### 2. 故障排查
- 策略执行失败时手动重试
- 验证设备配置是否正确
- 测试网络连接状态

### 3. 紧急备份
- 需要立即备份时使用
- 不等待调度时间
- 不影响原有备份计划

## 操作流程

### 1. 立即执行策略

1. **访问策略管理页面**
   - 点击侧边栏"备份策略"菜单

2. **找到目标策略**
   - 在策略列表中找到要执行的策略

3. **点击立即执行**
   - 点击策略行的"立即执行"按钮
   - 系统会立即执行备份操作

4. **查看执行结果**
   - 查看操作提示消息
   - 检查备份记录列表
   - 验证备份文件是否生成

### 2. 验证执行效果

1. **检查备份记录**
   - 访问"备份管理"页面
   - 查看是否有新的备份记录

2. **下载备份文件**
   - 点击备份记录的"下载"按钮
   - 验证备份文件内容

3. **查看执行日志**
   - 检查后端日志文件
   - 查看详细的执行信息

## 注意事项

### 1. 执行限制
- 只有启用状态的策略才能立即执行
- 需要确保设备连接正常
- 备份类型必须正确配置

### 2. 调度影响
- 立即执行不会影响原有的调度时间
- 不会更新策略的最后执行时间
- 不会改变下次执行时间

### 3. 错误处理
- 执行失败会显示具体错误信息
- 网络问题或设备连接失败会提示
- 备份命令执行失败会记录错误

## 测试验证

### 1. 功能测试

**测试步骤**:
1. 创建一个测试策略
2. 点击"立即执行"按钮
3. 检查是否生成备份记录
4. 验证备份文件内容

**预期结果**:
- 立即执行成功
- 生成新的备份记录
- 备份文件内容正确

### 2. 调度测试

**测试步骤**:
1. 设置策略为1分钟后执行
2. 点击"立即执行"
3. 等待调度时间到达
4. 检查是否再次执行

**预期结果**:
- 立即执行不影响调度
- 调度时间到达时正常执行
- 两次执行都成功

## 总结

立即执行功能提供了：

1. ✅ **快速验证**: 立即测试策略配置
2. ✅ **灵活执行**: 不依赖调度时间
3. ✅ **独立操作**: 不影响原有调度
4. ✅ **友好界面**: 清晰的按钮和提示
5. ✅ **完整反馈**: 详细的执行结果

这个功能让用户可以更方便地测试和验证备份策略，提高了系统的可用性和用户体验。
